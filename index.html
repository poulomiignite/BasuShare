<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BasuShare</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React UMD -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel (JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root{
      --peach:#d97c66;
      --peach2:#e8a191;
      --ink:#2a1f1b;
      --paper:#fff7f4;
      --card:#ffffff;
      --line:#f2e6e2;
    }
    html,body { height:100%; }
    body { background: var(--paper); color: var(--ink); -webkit-tap-highlight-color: transparent; }
    .no-scrollbar::-webkit-scrollbar { display:none; }
    .no-scrollbar { scrollbar-width:none; -ms-overflow-style:none; }
    .card { background: var(--card); border: 1px solid var(--line); }
    .btn { background: var(--peach); color:#fff; }
    .btn:hover { filter: brightness(0.97); }
    .btn:active { transform: translateY(1px); }
    .btn2 { background: rgba(217,124,102,0.12); color: var(--peach); border: 1px solid rgba(217,124,102,0.20); }
    .pill { background: rgba(217,124,102,0.12); color: var(--peach); border: 1px solid rgba(217,124,102,0.20); }
    .shadowSoft { box-shadow: 0 18px 50px rgba(42,31,27,0.10); }
    .modalBackdrop { background: rgba(42,31,27,0.55); backdrop-filter: blur(10px); }
    .topGrad {
      background: radial-gradient(1000px 400px at 50% -150px, rgba(217,124,102,0.30), transparent 70%);
    }
  </style>
</head>

<body class="topGrad">
  <div id="root"></div>

  <!-- Firebase (modules) -> expose to window for Babel script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      doc,
      updateDoc,
      deleteDoc,
      onSnapshot,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    window.FirebaseSDK = {
      initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy
    };
    window.dispatchEvent(new Event("firebase-ready"));
  </script>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState, useCallback } = React;

    // ‚úÖ Your config (already filled)
    const firebaseConfig = {
      apiKey: "AIzaSyBhKI5sBj3Y7bNoEy6dn0R4bER1AA-mz98",
      authDomain: "basushare.firebaseapp.com",
      projectId: "basushare",
      storageBucket: "basushare.firebasestorage.app",
      messagingSenderId: "455993556244",
      appId: "1:455993556244:web:7aa1949507879de26f9601"
    };

    // ---------- small helpers ----------
    const safeJSON = (v, fallback) => { try { return JSON.parse(v); } catch { return fallback; } };
    const now = () => Date.now();

    function useLocalStorage(key, initialValue) {
      const [val, setVal] = useState(() => {
        const raw = localStorage.getItem(key);
        return raw === null ? initialValue : safeJSON(raw, initialValue);
      });
      useEffect(() => localStorage.setItem(key, JSON.stringify(val)), [key, val]);
      return [val, setVal];
    }

    function formatMoney(n) {
      const x = Number(n || 0);
      return x.toFixed(2);
    }

    function Modal({ title, children, onClose }) {
      useEffect(() => {
        const onEsc = (e) => { if (e.key === "Escape") onClose(); };
        window.addEventListener("keydown", onEsc);
        return () => window.removeEventListener("keydown", onEsc);
      }, [onClose]);

      return (
        <div className="fixed inset-0 modalBackdrop z-[100] flex items-center justify-center p-4">
          <div className="w-full max-w-md card rounded-3xl shadowSoft overflow-hidden">
            <div className="px-6 py-5 flex items-center justify-between border-b border-[var(--line)]">
              <div className="font-extrabold tracking-tight text-lg">{title}</div>
              <button onClick={onClose} className="px-3 py-1.5 rounded-full btn2 font-bold text-sm">Close</button>
            </div>
            <div className="p-6">{children}</div>
          </div>
        </div>
      );
    }

    // ---------- main app ----------
    function App() {
      const [boot, setBoot] = useState({ ready:false, status:"Loading Firebase‚Ä¶" });
      const [db, setDb] = useState(null);
      const [user, setUser] = useState(null);

      const [recents, setRecents] = useLocalStorage("basushare_recents", []); // [{id,last}]
      const [identityByGroup, setIdentityByGroup] = useLocalStorage("basushare_identityByGroup", {}); // {groupId: memberId}

      const [groupId, setGroupId] = useState(() => decodeURIComponent((window.location.hash || "").replace("#","")) || "");
      const [members, setMembers] = useState([]);
      const [expenses, setExpenses] = useState([]);

      const [homeMode, setHomeMode] = useState(recents.length ? "existing" : "new");
      const [activeTab, setActiveTab] = useState("dashboard"); // dashboard | expenses | members

      const [showAddMember, setShowAddMember] = useState(false);
      const [showAddExpense, setShowAddExpense] = useState(false);

      const [toast, setToast] = useState(null);
      const toastTimer = useRef(null);
      const showToast = useCallback((msg) => {
        setToast(msg);
        clearTimeout(toastTimer.current);
        toastTimer.current = setTimeout(() => setToast(null), 2400);
      }, []);

      // boot firebase
      useEffect(() => {
        const init = async () => {
          if (!window.FirebaseSDK) {
            window.addEventListener("firebase-ready", init, { once:true });
            return;
          }
          try {
            const sdk = window.FirebaseSDK;
            setBoot({ ready:false, status:"Initializing‚Ä¶" });
            const app = sdk.initializeApp(firebaseConfig);
            const auth = sdk.getAuth(app);
            const firestore = sdk.getFirestore(app);
            setDb(firestore);

            setBoot({ ready:false, status:"Authenticating‚Ä¶" });
            await sdk.signInAnonymously(auth);

            sdk.onAuthStateChanged(auth, (u) => {
              if (u) {
                setUser(u);
                setBoot({ ready:true, status:"Ready" });
              }
            });
          } catch (e) {
            console.error(e);
            setBoot({ ready:true, status:"Ready (offline mode)" });
          }
        };
        init();
      }, []);

      // hash routing
      useEffect(() => {
        const sync = () => {
          const hash = decodeURIComponent((window.location.hash || "").replace("#",""));
          setGroupId(hash || "");
          if (!hash) {
            setMembers([]); setExpenses([]);
            setActiveTab("dashboard");
          }
        };
        window.addEventListener("hashchange", sync);
        sync();
        return () => window.removeEventListener("hashchange", sync);
      }, []);

      // persist recents
      const rememberGroup = useCallback((id) => {
        setRecents(prev => {
          const next = [{ id, last: now() }, ...prev.filter(x => x.id !== id)].slice(0, 12);
          return next;
        });
      }, [setRecents]);

      // firestore subscriptions
      useEffect(() => {
        if (!boot.ready || !db || !user || !groupId) return;
        const sdk = window.FirebaseSDK;

        const membersCol = sdk.collection(db, "groups", groupId, "members");
        const expensesCol = sdk.collection(db, "groups", groupId, "expenses");
        const expensesQ = sdk.query(expensesCol, sdk.orderBy("createdAt","asc"));

        const unsubMembers = sdk.onSnapshot(membersCol, (s) => {
          const list = s.docs.map(d => ({ id:d.id, ...d.data() }))
            .sort((a,b)=> (a.createdAt||0)-(b.createdAt||0));
          setMembers(list);
        }, (e)=>console.error(e));

        const unsubExpenses = sdk.onSnapshot(expensesQ, (s) => {
          const list = s.docs.map(d => ({ id:d.id, ...d.data() }));
          setExpenses(list);
        }, (e)=>console.error(e));

        rememberGroup(groupId);

        return () => { unsubMembers(); unsubExpenses(); };
      }, [boot.ready, db, user, groupId, rememberGroup]);

      // computed balances (Splitwise-style: payer gets +amount, each participant gets -share)
      const balancesByMemberId = useMemo(() => {
        const bal = {};
        members.forEach(m => bal[m.id] = 0);

        expenses.forEach(e => {
          const amt = Number(e.amount || 0);
          if (!amt || !e.payerId) return;
          if (!bal[e.payerId] && bal[e.payerId] !== 0) bal[e.payerId] = 0;
          bal[e.payerId] += amt;

          const splits = e.splits || {}; // {memberId: share}
          Object.entries(splits).forEach(([mid, share]) => {
            if (!bal[mid] && bal[mid] !== 0) bal[mid] = 0;
            bal[mid] -= Number(share || 0);
          });
        });

        // round to cents
        Object.keys(bal).forEach(k => bal[k] = Math.round(bal[k]*100)/100);
        return bal;
      }, [members, expenses]);

      // identity + view dropdown
      const currentMemberId = groupId ? (identityByGroup[groupId] || "") : "";
      const setCurrentMemberId = (mid) => {
        setIdentityByGroup(prev => ({ ...prev, [groupId]: mid }));
      };

      const currentPocket = useMemo(() => {
        if (!currentMemberId) return null;
        const me = balancesByMemberId[currentMemberId] || 0;
        // "Receivable" vs "Payable" as simple split: + means owed to you, - means you owe
        return { net: me, receivable: me > 0 ? me : 0, payable: me < 0 ? Math.abs(me) : 0 };
      }, [currentMemberId, balancesByMemberId]);

      // ---------- UI states ----------
      if (!boot.ready) {
        return (
          <div className="min-h-screen flex items-center justify-center p-6">
            <div className="card rounded-3xl shadowSoft p-8 w-full max-w-md text-center">
              <div className="text-3xl mb-3">üçë</div>
              <div className="font-extrabold text-xl tracking-tight">BasuShare</div>
              <div className="text-sm opacity-70 mt-2">{boot.status}</div>
              <div className="mt-6 h-2 bg-[var(--line)] rounded-full overflow-hidden">
                <div className="h-full w-1/3 bg-[var(--peach)] animate-pulse rounded-full"></div>
              </div>
            </div>
          </div>
        );
      }

      // ---------- HOME (no group selected) ----------
      if (!groupId) {
        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <div className="w-full max-w-3xl">
              <header className="text-center mb-6">
                <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full pill font-extrabold tracking-tight">
                  BasuShare
                </div>
                <h1 className="text-4xl font-black tracking-tight mt-4">Shared expenses, without the chaos.</h1>
                <p className="opacity-70 mt-2">Create a group, add people, log expenses. Share the link. Done.</p>
              </header>

              <div className="card rounded-3xl shadowSoft p-6">
                <div className="flex items-center justify-center gap-2 mb-6">
                  <button
                    className={"px-4 py-2 rounded-full font-extrabold text-sm " + (homeMode==="existing" ? "btn" : "btn2")}
                    onClick={()=>setHomeMode("existing")}
                  >
                    Existing groups
                  </button>
                  <button
                    className={"px-4 py-2 rounded-full font-extrabold text-sm " + (homeMode==="new" ? "btn" : "btn2")}
                    onClick={()=>setHomeMode("new")}
                  >
                    Add a group
                  </button>
                </div>

                {homeMode === "existing" ? (
                  <div>
                    {recents.length ? (
                      <div className="grid md:grid-cols-2 gap-4">
                        {recents.map(g => (
                          <div key={g.id} className="card rounded-2xl p-5 flex items-center justify-between">
                            <div className="min-w-0">
                              <div className="font-extrabold text-lg truncate">{g.id}</div>
                              <div className="text-xs opacity-60 mt-1">Saved on this device</div>
                            </div>
                            <div className="flex items-center gap-2">
                              <button
                                className="px-3 py-2 rounded-xl btn2 font-extrabold text-sm"
                                onClick={() => { window.location.hash = encodeURIComponent(g.id); }}
                              >
                                Open
                              </button>
                              <button
                                className="px-3 py-2 rounded-xl btn2 font-extrabold text-sm"
                                onClick={() => {
                                  setRecents(prev => prev.filter(x => x.id !== g.id));
                                }}
                                title="Remove from this device"
                              >
                                Remove
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div className="text-center p-10 rounded-2xl bg-white border border-[var(--line)]">
                        <div className="text-lg font-extrabold">No saved groups yet.</div>
                        <div className="opacity-70 mt-2">Create one and it will appear here on this device.</div>
                        <button className="mt-6 px-5 py-3 rounded-2xl btn font-extrabold" onClick={()=>setHomeMode("new")}>
                          Create a group
                        </button>
                      </div>
                    )}
                  </div>
                ) : (
                  <CreateGroupCard onOpen={(id)=>{ window.location.hash = encodeURIComponent(id); }} />
                )}
              </div>

              <div className="text-center text-xs opacity-60 mt-6">
                Tip: share the group link with family members so everyone sees the same data.
              </div>
            </div>
          </div>
        );
      }

      // ---------- GROUP SCREEN ----------
      return (
        <div className="min-h-screen">
          {toast && (
            <div className="fixed top-6 left-1/2 -translate-x-1/2 z-[200] px-5 py-3 rounded-full shadowSoft btn font-extrabold">
              {toast}
            </div>
          )}

          <div className="max-w-3xl mx-auto p-4 pb-28">
            {/* Header */}
            <div className="card rounded-3xl shadowSoft p-5 mb-4">
              <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div className="min-w-0">
                  <div className="text-xs opacity-60 font-bold">Group</div>
                  <div className="text-2xl font-black tracking-tight truncate">{groupId}</div>
                </div>

                <div className="flex flex-wrap items-center gap-2">
                  <select
                    className="px-4 py-2 rounded-2xl border border-[var(--line)] bg-white font-extrabold"
                    value={currentMemberId}
                    onChange={(e)=>setCurrentMemberId(e.target.value)}
                    title="Choose whose balance to view"
                  >
                    <option value="">View as‚Ä¶</option>
                    {members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                  </select>

                  <button
                    className="px-4 py-2 rounded-2xl btn2 font-extrabold"
                    onClick={() => {
                      const link = `${window.location.origin}${window.location.pathname}#${encodeURIComponent(groupId)}`;
                      navigator.clipboard.writeText(link).then(()=>showToast("Group link copied"));
                    }}
                  >
                    Copy link
                  </button>

                  <button
                    className="px-4 py-2 rounded-2xl btn2 font-extrabold"
                    onClick={() => { window.location.hash = ""; }}
                  >
                    Home
                  </button>
                </div>
              </div>

              {/* Pocket summary */}
              <div className="mt-5 grid md:grid-cols-3 gap-3">
                <div className="rounded-2xl p-4 bg-white border border-[var(--line)]">
                  <div className="text-xs opacity-60 font-bold">Total expenses</div>
                  <div className="text-2xl font-black mt-1">
                    ‚Ç¨{formatMoney(expenses.reduce((s,e)=>s+Number(e.amount||0),0))}
                  </div>
                </div>

                <div className="rounded-2xl p-4 bg-white border border-[var(--line)]">
                  <div className="text-xs opacity-60 font-bold">Your receivable</div>
                  <div className="text-2xl font-black mt-1" style={{color:"var(--peach)"}}>
                    ‚Ç¨{formatMoney(currentPocket?.receivable || 0)}
                  </div>
                </div>

                <div className="rounded-2xl p-4 bg-white border border-[var(--line)]">
                  <div className="text-xs opacity-60 font-bold">Your payable</div>
                  <div className="text-2xl font-black mt-1">
                    ‚Ç¨{formatMoney(currentPocket?.payable || 0)}
                  </div>
                </div>
              </div>
            </div>

            {/* Tabs */}
            <div className="flex gap-2 mb-4">
              <TabButton active={activeTab==="dashboard"} onClick={()=>setActiveTab("dashboard")}>Dashboard</TabButton>
              <TabButton active={activeTab==="expenses"} onClick={()=>setActiveTab("expenses")}>Expenses</TabButton>
              <TabButton active={activeTab==="members"} onClick={()=>setActiveTab("members")}>People</TabButton>
            </div>

            {/* Content */}
            {activeTab === "dashboard" && (
              <div className="space-y-4">
                <div className="card rounded-3xl shadowSoft p-6">
                  <div className="flex items-center justify-between">
                    <div className="font-extrabold text-lg">Balances</div>
                    <button className="px-4 py-2 rounded-2xl btn2 font-extrabold" onClick={()=>setShowAddMember(true)}>
                      Add person
                    </button>
                  </div>

                  <div className="mt-4 grid gap-3">
                    {members.length ? members.map(m => {
                      const val = balancesByMemberId[m.id] || 0;
                      const isPos = val >= 0;
                      return (
                        <div key={m.id} className={"rounded-2xl p-4 border flex items-center justify-between " + (currentMemberId===m.id ? "border-[rgba(217,124,102,0.55)] bg-[rgba(217,124,102,0.08)]" : "border-[var(--line)] bg-white")}>
                          <div className="min-w-0">
                            <div className="font-extrabold truncate">{m.name}</div>
                            <div className="text-xs opacity-60 mt-1">
                              {isPos ? "is owed" : "owes"} ‚Ç¨{formatMoney(Math.abs(val))}
                            </div>
                          </div>
                          <div className="font-black text-xl" style={{color: isPos ? "var(--peach)" : "var(--ink)"}}>
                            {isPos ? "+" : "-"}‚Ç¨{formatMoney(Math.abs(val))}
                          </div>
                        </div>
                      );
                    }) : (
                      <div className="text-sm opacity-70">
                        Add at least one person to start.
                      </div>
                    )}
                  </div>
                </div>

                <div className="card rounded-3xl shadowSoft p-6">
                  <div className="flex items-center justify-between">
                    <div className="font-extrabold text-lg">Recent activity</div>
                    <button className="px-4 py-2 rounded-2xl btn2 font-extrabold" onClick={()=>setShowAddExpense(true)}>
                      Add expense
                    </button>
                  </div>

                  <div className="mt-4 space-y-3">
                    {expenses.length ? expenses.slice(-6).reverse().map(e => (
                      <div key={e.id} className="rounded-2xl p-4 bg-white border border-[var(--line)] flex items-center justify-between">
                        <div className="min-w-0">
                          <div className="font-extrabold truncate">{e.title || "Expense"}</div>
                          <div className="text-xs opacity-60 mt-1">
                            Paid by <span className="font-bold">{members.find(m=>m.id===e.payerId)?.name || "‚Äî"}</span>
                          </div>
                        </div>
                        <div className="font-black text-lg">‚Ç¨{formatMoney(e.amount)}</div>
                      </div>
                    )) : (
                      <div className="text-sm opacity-70">
                        No expenses yet. Add your first one.
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {activeTab === "expenses" && (
              <div className="card rounded-3xl shadowSoft p-6">
                <div className="flex items-center justify-between">
                  <div className="font-extrabold text-lg">All expenses</div>
                  <button className="px-4 py-2 rounded-2xl btn font-extrabold" onClick={()=>setShowAddExpense(true)}>
                    + Add
                  </button>
                </div>

                <div className="mt-4 space-y-3">
                  {expenses.length ? expenses.slice().reverse().map(e => (
                    <div key={e.id} className="rounded-2xl p-4 bg-white border border-[var(--line)]">
                      <div className="flex items-start justify-between gap-3">
                        <div className="min-w-0">
                          <div className="font-extrabold truncate">{e.title || "Expense"}</div>
                          <div className="text-xs opacity-60 mt-1">
                            Paid by <span className="font-bold">{members.find(m=>m.id===e.payerId)?.name || "‚Äî"}</span>
                          </div>
                        </div>
                        <div className="font-black text-lg">‚Ç¨{formatMoney(e.amount)}</div>
                      </div>

                      <div className="mt-3 text-xs opacity-70">
                        Split:{" "}
                        {Object.entries(e.splits||{}).map(([mid,share]) => {
                          const nm = members.find(m=>m.id===mid)?.name || "‚Äî";
                          return <span key={mid} className="inline-block mr-3"><b>{nm}</b> ‚Ç¨{formatMoney(share)}</span>;
                        })}
                      </div>
                    </div>
                  )) : (
                    <div className="text-sm opacity-70">No expenses yet.</div>
                  )}
                </div>
              </div>
            )}

            {activeTab === "members" && (
              <div className="card rounded-3xl shadowSoft p-6">
                <div className="flex items-center justify-between">
                  <div className="font-extrabold text-lg">People</div>
                  <button className="px-4 py-2 rounded-2xl btn font-extrabold" onClick={()=>setShowAddMember(true)}>
                    + Add
                  </button>
                </div>

                <div className="mt-4 space-y-3">
                  {members.length ? members.map(m => (
                    <div key={m.id} className="rounded-2xl p-4 bg-white border border-[var(--line)] flex items-center justify-between">
                      <div className="font-extrabold">{m.name}</div>
                      <button
                        className="px-3 py-2 rounded-xl btn2 font-extrabold text-sm"
                        onClick={() => setCurrentMemberId(m.id)}
                      >
                        View as
                      </button>
                    </div>
                  )) : (
                    <div className="text-sm opacity-70">No people yet.</div>
                  )}
                </div>
              </div>
            )}
          </div>

          {/* Floating action buttons */}
          <div className="fixed bottom-5 left-1/2 -translate-x-1/2 z-[50]">
            <div className="flex items-center gap-3 card rounded-full shadowSoft px-3 py-3">
              <button className="px-5 py-3 rounded-full btn font-extrabold" onClick={()=>setShowAddExpense(true)}>
                Add expense
              </button>
              <button className="px-5 py-3 rounded-full btn2 font-extrabold" onClick={()=>setShowAddMember(true)}>
                Add person
              </button>
            </div>
          </div>

          {/* Modals */}
          {showAddMember && (
    <Modal title="Add person" onClose={()=>setShowAddMember(false)}>
      <AddMemberForm
        groupId={groupId}
        db={db}
        members={members}
        onDone={() => { setShowAddMember(false); showToast("Person added"); }}
      />
    </Modal>
  )}

  {showAddExpense && (
    <Modal title="Add expense" onClose={()=>setShowAddExpense(false)}>
      <AddExpenseForm
        groupId={groupId}
        db={db}
        members={members}
        onDone={() => { setShowAddExpense(false); showToast("Expense added"); }}
      />
    </Modal>
  )}
        </div>
      );
    }

    function TabButton({ active, onClick, children }) {
      return (
        <button
          onClick={onClick}
          className={
            "px-4 py-2 rounded-2xl font-extrabold text-sm border " +
            (active
              ? "btn border-transparent"
              : "bg-white border-[var(--line)] hover:bg-[rgba(217,124,102,0.06)]")
          }
        >
          {children}
        </button>
      );
    }

    function CreateGroupCard({ onOpen }) {
      const [gid, setGid] = useState("");
      return (
        <div className="rounded-3xl p-6 bg-white border border-[var(--line)]">
          <div className="font-extrabold text-lg">Create / open a group</div>
          <div className="opacity-70 text-sm mt-1">Example: Home-Bills or Italy-Trip</div>
          <input
            className="mt-4 w-full px-4 py-3 rounded-2xl border border-[var(--line)] bg-white font-bold"
            placeholder="Group name"
            value={gid}
            onChange={(e)=>setGid(e.target.value)}
          />
          <button
            className="mt-4 w-full px-5 py-3 rounded-2xl btn font-extrabold"
            onClick={()=> {
              const v = (gid||"").trim();
              if (!v) return;
              onOpen(v);
            }}
          >
            Open group
          </button>
        </div>
      );
    }

    function AddMemberForm({ groupId, db, members, onDone }) {
      const [name, setName] = useState("");
      const sdk = window.FirebaseSDK;

      return (
        <div className="space-y-4">
          <div className="text-sm opacity-70">
            Add a person to this group. Everyone with the link will see them.
          </div>

          <input
            className="w-full px-4 py-3 rounded-2xl border border-[var(--line)] bg-white font-bold"
            placeholder="Name"
            value={name}
            onChange={(e)=>setName(e.target.value)}
            autoFocus
          />

          <button
            className="w-full px-5 py-3 rounded-2xl btn font-extrabold"
            onClick={async () => {
              const nm = (name||"").trim();
              if (!nm) return;
              // avoid duplicates by name (simple guard)
              const exists = members.some(m => (m.name||"").toLowerCase() === nm.toLowerCase());
              if (exists) { onDone(); return; }

              await sdk.addDoc(sdk.collection(db, "groups", groupId, "members"), {
                name: nm,
                createdAt: Date.now()
              });
              onDone();
            }}
          >
            Add person
          </button>
        </div>
      );
    }

    function AddExpenseForm({ groupId, db, members, onDone }) {
      const sdk = window.FirebaseSDK;

      const [title, setTitle] = useState("");
      const [amount, setAmount] = useState("");
      const [payerId, setPayerId] = useState("");

      // default to first member when available
      useEffect(() => {
        if (!payerId && members[0]?.id) setPayerId(members[0].id);
      }, [members, payerId]);

      const computeEqualSplits = () => {
        const total = Number(amount || 0);
        const n = members.length || 1;
        const each = Math.round((total / n) * 100) / 100;

        // fix rounding drift by adjusting last
        const splits = {};
        let running = 0;
        members.forEach((m, idx) => {
          if (idx === n - 1) {
            splits[m.id] = Math.round((total - running) * 100) / 100;
          } else {
            splits[m.id] = each;
            running += each;
          }
        });
        return splits;
      };

      return (
        <div className="space-y-4">
          {!members.length && (
            <div className="p-4 rounded-2xl bg-white border border-[var(--line)] text-sm">
              Add at least one person first.
            </div>
          )}

          <div>
            <div className="text-xs font-bold opacity-60 mb-1">What is this for?</div>
            <input
              className="w-full px-4 py-3 rounded-2xl border border-[var(--line)] bg-white font-bold"
              placeholder="Dinner, groceries, rent‚Ä¶"
              value={title}
              onChange={(e)=>setTitle(e.target.value)}
              autoFocus
            />
          </div>

          <div>
            <div className="text-xs font-bold opacity-60 mb-1">Amount</div>
            <div className="flex items-center gap-2">
              <div className="px-3 py-3 rounded-2xl border border-[var(--line)] bg-white font-black">‚Ç¨</div>
              <input
                type="number"
                step="0.01"
                className="w-full px-4 py-3 rounded-2xl border border-[var(--line)] bg-white font-bold"
                placeholder="0.00"
                value={amount}
                onChange={(e)=>setAmount(e.target.value)}
              />
            </div>
          </div>

          <div>
            <div className="text-xs font-bold opacity-60 mb-1">Paid by</div>
            <select
              className="w-full px-4 py-3 rounded-2xl border border-[var(--line)] bg-white font-bold"
              value={payerId}
              onChange={(e)=>setPayerId(e.target.value)}
              disabled={!members.length}
            >
              {members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
            </select>
          </div>

          <div className="text-xs opacity-70">
            Split method: <b>Equally</b> (for now). We can add ‚Äúexact / parts‚Äù next.
          </div>

          <button
            className="w-full px-5 py-3 rounded-2xl btn font-extrabold"
            disabled={!members.length}
            onClick={async () => {
              const t = (title||"").trim();
              const amt = Number(amount || 0);
              if (!t || !amt || !payerId || !members.length) return;

              const splits = computeEqualSplits();

              await sdk.addDoc(sdk.collection(db, "groups", groupId, "expenses"), {
                title: t,
                amount: amt,
                payerId,
                splits,
                createdAt: Date.now()
              });

              onDone();
            }}
          >
            Add expense
          </button>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
