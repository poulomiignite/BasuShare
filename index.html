<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>BasuShare</title>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- React -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
body {
  font-family: 'Open Sans', sans-serif;
  background:#fff7f5;
}
</style>
</head>

<body>
<div id="root"></div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, updateDoc, deleteDoc,
  doc, onSnapshot
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

window.Firebase = {
  initializeApp, getAuth, signInAnonymously,
  getFirestore, collection, addDoc, updateDoc,
  deleteDoc, doc, onSnapshot
};
</script>

<script type="text/babel">

const { useState, useEffect } = React;

/* ---------- CONFIG ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyBhKIs5Bj3Y7bNoEy6dn0R4bER1AA-mz98",
  authDomain: "basushare.firebaseapp.com",
  projectId: "basushare",
};
const app = Firebase.initializeApp(firebaseConfig);
const auth = Firebase.getAuth(app);
const db = Firebase.getFirestore(app);

/* ---------- HELPERS ---------- */
const round = n => Math.round(n * 100) / 100;

/* ---------- APP ---------- */
function App() {
  const [group, setGroup] = useState(location.hash.replace("#",""));
  const [members, setMembers] = useState([]);
  const [expenses, setExpenses] = useState([]);
  const [me, setMe] = useState(localStorage.getItem("me") || "");
  const [showExpense, setShowExpense] = useState(null);

  useEffect(() => {
    Firebase.signInAnonymously(auth);
  }, []);

  useEffect(() => {
    if (!group) return;
    const mRef = collection(db,"groups",group,"members");
    const eRef = collection(db,"groups",group,"expenses");
    const u1 = onSnapshot(mRef,s=>setMembers(s.docs.map(d=>({...d.data(),id:d.id}))));
    const u2 = onSnapshot(eRef,s=>setExpenses(s.docs.map(d=>({...d.data(),id:d.id}))));
    return ()=>{u1();u2();}
  },[group]);

  const balances = {};
  members.forEach(m=>balances[m.id]=0);
  expenses.forEach(e=>{
    balances[e.payer]+=e.amount;
    Object.entries(e.splits).forEach(([id,v])=>{
      balances[id]-=v;
    });
  });

  return (
    <div className="max-w-md mx-auto min-h-screen bg-white shadow">
      {!group && (
        <div className="p-10 text-center">
          <h1 className="text-3xl font-bold mb-6 text-rose-600">BasuShare</h1>
          <input
            placeholder="Group name"
            className="w-full border p-3 rounded mb-4"
            onKeyDown={e=>e.key==="Enter"&&(location.hash=e.target.value)}
          />
          <button
            className="w-full bg-rose-500 text-white py-3 rounded"
            onClick={()=>location.hash=document.querySelector("input").value}
          >Open Group</button>
        </div>
      )}

      {group && (
        <>
          <header className="p-4 flex justify-between items-center bg-rose-500 text-white">
            <button onClick={()=>location.hash=""}>üè†</button>
            <h2 className="font-bold truncate">{group}</h2>
            <span />
          </header>

          <main className="p-4 space-y-4">
            <section>
              <h3 className="font-bold mb-2">Members</h3>
              {members.map(m=>(
                <div key={m.id} className="flex justify-between py-2">
                  <button onClick={()=>{setMe(m.id);localStorage.setItem("me",m.id)}}>
                    {m.name}{me===m.id&&" (you)"}
                  </button>
                  <span className={balances[m.id]>=0?"text-green-600":"text-red-500"}>
                    ‚Ç¨{round(balances[m.id])}
                  </span>
                </div>
              ))}
              <button
                className="text-sm text-rose-500"
                onClick={async()=>{
                  const n=prompt("Name");
                  if(n) await addDoc(collection(db,"groups",group,"members"),{name:n});
                }}
              >+ Add person</button>
            </section>

            <section>
              <h3 className="font-bold mb-2">Expenses</h3>
              {expenses.map(e=>(
                <div key={e.id} className="border p-3 rounded mb-2">
                  <div className="flex justify-between">
                    <strong>{e.title}</strong>
                    <span>‚Ç¨{e.amount}</span>
                  </div>
                  <div className="text-sm text-gray-500">
                    Paid by {members.find(m=>m.id===e.payer)?.name}
                  </div>
                  <div className="flex gap-4 mt-2 text-sm">
                    <button onClick={()=>setShowExpense(e)}>Edit</button>
                    <button onClick={()=>deleteDoc(doc(db,"groups",group,"expenses",e.id))}>Delete</button>
                  </div>
                </div>
              ))}
            </section>
          </main>

          <button
            className="fixed bottom-6 right-6 bg-rose-500 text-white w-14 h-14 rounded-full text-2xl"
            onClick={()=>setShowExpense({})}
          >+</button>
        </>
      )}

      {showExpense!==null && (
        <ExpenseModal
          expense={showExpense}
          members={members}
          onClose={()=>setShowExpense(null)}
          onSave={async data=>{
            if(showExpense.id){
              await updateDoc(doc(db,"groups",group,"expenses",showExpense.id),data);
            }else{
              await addDoc(collection(db,"groups",group,"expenses"),data);
            }
            setShowExpense(null);
          }}
        />
      )}
    </div>
  );
}

/* ---------- EXPENSE MODAL ---------- */
function ExpenseModal({expense,members,onClose,onSave}) {
  const [title,setTitle]=useState(expense.title||"");
  const [amount,setAmount]=useState(expense.amount||0);
  const [payer,setPayer]=useState(expense.payer||members[0]?.id);
  const [method,setMethod]=useState(expense.method||"equal");
  const [vals,setVals]=useState({});

  useEffect(()=>{
    const v={};
    members.forEach(m=>v[m.id]=1);
    setVals(v);
  },[members]);

  const splits=()=>{
    const out={};
    if(method==="equal"){
      members.forEach(m=>out[m.id]=amount/members.length);
    }else if(method==="parts"){
      const sum=Object.values(vals).reduce((a,b)=>a+Number(b),0);
      members.forEach(m=>out[m.id]=amount*(vals[m.id]/sum));
    }else if(method==="percent"){
      members.forEach(m=>out[m.id]=amount*(vals[m.id]/100));
    }else{
      members.forEach(m=>out[m.id]=Number(vals[m.id]||0));
    }
    return out;
  };

  return (
    <div className="fixed inset-0 bg-black/40 flex items-end">
      <div className="bg-white w-full p-6 rounded-t-xl">
        <input value={title} onChange={e=>setTitle(e.target.value)} placeholder="Title" className="w-full border p-2 mb-2"/>
        <input type="number" value={amount} onChange={e=>setAmount(Number(e.target.value))} className="w-full border p-2 mb-2"/>
        <select value={payer} onChange={e=>setPayer(e.target.value)} className="w-full border p-2 mb-2">
          {members.map(m=><option key={m.id} value={m.id}>{m.name}</option>)}
        </select>
        <select value={method} onChange={e=>setMethod(e.target.value)} className="w-full border p-2 mb-2">
          <option value="equal">Equal</option>
          <option value="parts">Parts</option>
          <option value="percent">Percent</option>
          <option value="actual">Actual</option>
        </select>

        {members.map(m=>(
          <input key={m.id}
            type="number"
            placeholder={m.name}
            className="w-full border p-2 mb-1"
            onChange={e=>setVals({...vals,[m.id]:e.target.value})}
          />
        ))}

        <div className="flex gap-4 mt-4">
          <button className="flex-1 bg-gray-200 py-2" onClick={onClose}>Cancel</button>
          <button className="flex-1 bg-rose-500 text-white py-2"
            onClick={()=>onSave({title,amount,payer,method,splits:splits()})}
          >Save</button>
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>

</body>
</html>
